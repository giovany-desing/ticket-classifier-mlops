name: ðŸš€ Deploy to Render

on:
  # Este workflow ahora se ejecuta como parte de ci_cd_pipeline.yml
  # Mantener para ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      description:
        description: 'DescripciÃ³n del deploy'
        required: false
        default: 'Deploy manual'

# Control de concurrencia - evita deploys simultÃ¡neos
concurrency:
  group: deploy-render
  cancel-in-progress: false

env:
  RENDER_SERVICE_NAME: ticket-classifier-api

jobs:
  deploy:
    name: ðŸš€ Deploy API to Render
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ======================================================================
      # PRE-DEPLOY CHECKS
      # ======================================================================

      - name: ðŸ” Verify required files exist
        run: |
          echo "Verificando archivos requeridos..."

          # Verificar archivos crÃ­ticos
          for file in "api/inference.py" "requirements.txt" "config.yaml"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Archivo faltante: $file"
              exit 1
            fi
            echo "âœ… $file existe"
          done

          echo ""
          echo "âœ… Todos los archivos requeridos estÃ¡n presentes"

      - name: ðŸ Setup Python (for validation)
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: ðŸ” Validate Python syntax
        run: |
          echo "Validando sintaxis de Python..."
          python -m py_compile api/inference.py
          python -m py_compile utils/monitoring.py
          python -m py_compile utils/database.py
          echo "âœ… Sintaxis vÃ¡lida"

      # ======================================================================
      # DEPLOY TO RENDER
      # ======================================================================

      - name: ðŸš€ Trigger Render Deploy
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "âŒ RENDER_DEPLOY_HOOK_URL no estÃ¡ configurado en secrets"
            echo ""
            echo "ðŸ“‹ Para configurarlo:"
            echo "1. Ve a Render Dashboard â†’ tu servicio â†’ Settings â†’ Deploy Hook"
            echo "2. Copia la URL del Deploy Hook"
            echo "3. En GitHub â†’ Settings â†’ Secrets â†’ Actions â†’ New secret"
            echo "4. Nombre: RENDER_DEPLOY_HOOK_URL"
            echo "5. Valor: la URL copiada de Render"
            exit 1
          fi

          echo "ðŸš€ Disparando deploy en Render..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$RENDER_DEPLOY_HOOK_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Deploy disparado exitosamente"
            echo "ðŸ“‹ Respuesta: $BODY"
          else
            echo "âŒ Error disparando deploy (HTTP $HTTP_CODE)"
            echo "ðŸ“‹ Respuesta: $BODY"
            exit 1
          fi

      # ======================================================================
      # WAIT FOR DEPLOY (OPTIONAL - puede tardar)
      # ======================================================================

      - name: â³ Wait for deploy to start
        run: |
          echo "Esperando 30 segundos para que inicie el deploy..."
          sleep 30

      - name: ðŸ” Health check (post-deploy)
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          if [ -z "$API_URL" ]; then
            echo "âš ï¸ API_URL no configurada, saltando health check"
            echo "ðŸ’¡ Configura API_URL en secrets para verificar el deploy"
            exit 0
          fi

          echo "ðŸ” Verificando health de la API..."

          # Intentar hasta 5 veces con espera entre intentos
          MAX_ATTEMPTS=5
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Intento $ATTEMPT de $MAX_ATTEMPTS..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "$API_URL/health" \
              --max-time 10)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… API respondiendo correctamente"
              exit 0
            fi

            echo "â³ API no disponible (HTTP $HTTP_CODE), esperando 30s..."
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âš ï¸ API no respondiÃ³ despuÃ©s de $MAX_ATTEMPTS intentos"
          echo "ðŸ’¡ El deploy puede seguir en progreso. Verifica en Render Dashboard."
          # No fallar el workflow, solo advertir

      # ======================================================================
      # SUMMARY
      # ======================================================================

      - name: ðŸ“‹ Generate summary
        if: always()
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          echo "# ðŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ env.RENDER_SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$API_URL" ]; then
            echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
            echo "- **API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check:** $API_URL/health" >> $GITHUB_STEP_SUMMARY
            echo "- **Docs:** $API_URL/docs" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify deployment in [Render Dashboard](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
          echo "2. Check API health: \`curl $API_URL/health\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Test prediction endpoint" >> $GITHUB_STEP_SUMMARY
