name: ‚úÖ Validate Project

on:
  # Este workflow ahora se ejecuta como parte de ci_cd_pipeline.yml
  # Mantener para PRs y ejecuci√≥n manual
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# Control de concurrencia
concurrency:
  group: validate-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.9'

jobs:
  validate:
    name: ‚úÖ Validate Project
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ======================================================================
      # SETUP
      # ======================================================================
      
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # ======================================================================
      # VALIDACIONES
      # ======================================================================
      
      - name: üîç Verify required files exist
        run: |
          echo "Verificando archivos requeridos..."
          
          REQUIRED_FILES=(
            "api/inference.py"
            "requirements.txt"
            "config.yaml"
            "scripts/train_model.py"
            "utils/preprocessing_data.py"
            "utils/monitoring.py"
            "utils/database.py"
          )
          
          MISSING_FILES=()
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Archivo faltante: $file"
              MISSING_FILES+=("$file")
            else
              echo "‚úÖ $file existe"
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Archivos faltantes:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Todos los archivos requeridos est√°n presentes"
      
      - name: üîç Verify DVC files exist
        run: |
          echo "Verificando archivos DVC..."
          
          # Verificar que el archivo .dvc del modelo existe (aunque el .pkl no)
          if [ ! -f "models/best_model.pkl.dvc" ]; then
            echo "‚ö†Ô∏è models/best_model.pkl.dvc no existe"
            echo "  Esto es normal si es la primera vez, pero necesitar√°s entrenar un modelo"
          else
            echo "‚úÖ models/best_model.pkl.dvc existe"
          fi
          
          # Verificar que el archivo .dvc del dataset existe
          if [ ! -f "data-tickets-train/dataset_tickets.csv.dvc" ]; then
            echo "‚ö†Ô∏è data-tickets-train/dataset_tickets.csv.dvc no existe"
          else
            echo "‚úÖ data-tickets-train/dataset_tickets.csv.dvc existe"
          fi
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
      
      - name: üîç Validate Python syntax
        run: |
          echo "Validando sintaxis de Python..."
          
          PYTHON_FILES=(
            "api/inference.py"
            "scripts/train_model.py"
            "scripts/monitor_and_retrain.py"
            "scripts/deploy_model.py"
            "utils/preprocessing_data.py"
            "utils/monitoring.py"
            "utils/database.py"
            "scripts/download_model.py"
          )
          
          for file in "${PYTHON_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Validando $file..."
              python -m py_compile "$file" || {
                echo "‚ùå Error de sintaxis en $file"
                exit 1
              }
            fi
          done
          
          echo "‚úÖ Sintaxis v√°lida en todos los archivos"
      
      - name: üîç Validate imports
        run: |
          echo "Validando imports..."
          
          python << 'PYTHON_EOF'
import sys
import importlib.util

def check_import(module_name, file_path):
    """Verifica que un m√≥dulo puede importarse"""
    try:
        spec = importlib.util.spec_from_file_location(module_name, file_path)
        if spec is None:
            print(f"‚ùå No se pudo cargar {file_path}")
            return False
        module = importlib.util.module_from_spec(spec)
        # No ejecutar el m√≥dulo, solo verificar que se puede cargar
        print(f"‚úÖ {file_path} puede importarse")
        return True
    except SyntaxError as e:
        print(f"‚ùå Error de sintaxis en {file_path}: {e}")
        return False
    except Exception as e:
        # Algunos imports pueden fallar por dependencias faltantes, eso est√° bien
        print(f"‚ö†Ô∏è {file_path} tiene imports que pueden fallar: {e}")
        return True

# Verificar archivos principales
files_to_check = [
    ("api.inference", "api/inference.py"),
    ("utils.preprocessing_data", "utils/preprocessing_data.py"),
    ("utils.monitoring", "utils/monitoring.py"),
    ("utils.database", "utils/database.py"),
]

all_ok = True
for module_name, file_path in files_to_check:
    if not check_import(module_name, file_path):
        all_ok = False

if not all_ok:
    sys.exit(1)

print("‚úÖ Todos los imports son v√°lidos")
PYTHON_EOF
      
      - name: üîç Validate config.yaml
        run: |
          echo "Validando config.yaml..."
          
          python << 'PYTHON_EOF'
import yaml
import sys

try:
    with open('config.yaml', 'r') as f:
        config = yaml.safe_load(f)
    
    # Verificar secciones requeridas
    required_sections = ['data', 'preprocessing', 'monitoring', 'api']
    
    for section in required_sections:
        if section not in config:
            print(f"‚ùå Secci√≥n faltante en config.yaml: {section}")
            sys.exit(1)
        print(f"‚úÖ Secci√≥n '{section}' presente")
    
    print("‚úÖ config.yaml es v√°lido")
    
except yaml.YAMLError as e:
    print(f"‚ùå Error parseando config.yaml: {e}")
    sys.exit(1)
except Exception as e:
    print(f"‚ùå Error validando config.yaml: {e}")
    sys.exit(1)
PYTHON_EOF
      
      - name: üîç Validate render.yaml (if exists)
        run: |
          if [ -f "render.yaml" ]; then
            echo "Validando render.yaml..."
            
            python << 'PYTHON_EOF'
import yaml
import sys

try:
    with open('render.yaml', 'r') as f:
        render_config = yaml.safe_load(f)
    
    if 'services' not in render_config:
        print("‚ùå render.yaml debe tener secci√≥n 'services'")
        sys.exit(1)
    
    print("‚úÖ render.yaml es v√°lido")
    
except yaml.YAMLError as e:
    print(f"‚ùå Error parseando render.yaml: {e}")
    sys.exit(1)
except Exception as e:
    print(f"‚ùå Error validando render.yaml: {e}")
    sys.exit(1)
PYTHON_EOF
          else
            echo "‚ö†Ô∏è render.yaml no existe (opcional)"
          fi
      
      # ======================================================================
      # SUMMARY
      # ======================================================================
      
      - name: üìã Generate summary
        if: always()
        run: |
          echo "# ‚úÖ Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Validations Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Required files present" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Python syntax valid" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Imports valid" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Config files valid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Model files (.pkl) are not tracked in Git and will be downloaded from S3 during deployment." >> $GITHUB_STEP_SUMMARY

