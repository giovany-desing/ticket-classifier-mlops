name: ðŸ” Monitor and Auto-Retrain

on:
  schedule:
    # Ejecutar cada 6 horas
    - cron: '0 */6 * * *'
  
  workflow_dispatch:
    inputs:
      force_retrain:
        description: 'Forzar reentrenamiento incluso sin drift'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Control de concurrencia
concurrency:
  group: monitoring-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.9'
  AWS_REGION: us-east-1

jobs:
  monitor:
    name: ðŸ” Monitor Model & Auto-Retrain
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      # ======================================================================
      # SETUP
      # ======================================================================
      
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Instalar dependencias crÃ­ticas con versiones fijas para reproducibilidad
          if [ -f requirements-lock.txt ]; then
            pip install -r requirements-lock.txt
          fi
          # Instalar todas las dependencias (lock file tiene solo las crÃ­ticas)
          pip install -r requirements.txt
          pip install requests  # Para llamar a la API
      
      - name: ðŸ“š Download NLTK data
        run: |
          python -c "
          import nltk
          nltk.download('punkt', quiet=True)
          nltk.download('punkt_tab', quiet=True)
          nltk.download('stopwords', quiet=True)
          print('âœ“ NLTK resources ready')
          "
      
      # ======================================================================
      # DVC SETUP (para datos y modelos)
      # ======================================================================
      
      - name: ðŸ—„ï¸ Pull data and model from S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
        run: |
          echo "ðŸ“¥ Descargando dataset..."
          if ! dvc pull data-tickets-train/dataset_tickets.csv.dvc; then
            echo "âš ï¸ No se pudo descargar dataset, verificando si existe localmente..."
            if [ ! -f "data-tickets-train/dataset_tickets.csv" ]; then
              echo "âŒ Dataset no disponible ni local ni remotamente"
              exit 1
            fi
          fi
          
          echo "ðŸ“¥ Descargando modelo..."
          if ! dvc pull models/best_model.pkl.dvc; then
            echo "âš ï¸ No se pudo descargar modelo, verificando si existe localmente..."
            if [ ! -f "models/best_model.pkl" ]; then
              echo "âŒ Modelo no disponible - se requiere entrenamiento inicial"
              # No fallar si es primera vez
            fi
          fi
          
          echo "âœ… DVC pull completado"
          ls -lh data-tickets-train/ models/
      
      # ======================================================================
      # MONITOREO Y REENTRENAMIENTO
      # ======================================================================
      
      - name: ðŸ” Run monitoring and retrain if needed
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          API_URL: ${{ secrets.API_URL || 'http://localhost:8000' }}
          FORCE_RETRAIN: ${{ github.event.inputs.force_retrain || 'false' }}
        run: |
          echo "ðŸ” Ejecutando monitoreo..."
          
          # Si la API estÃ¡ disponible, verificar drift
          # Si no, asumir que necesitamos verificar con datos locales
          python scripts/monitor_and_retrain.py || {
            echo "âš ï¸ Monitoreo fallÃ³ o API no disponible"
            echo "Esto es normal si la API no estÃ¡ corriendo"
            exit 0
          }
      
      # ======================================================================
      # PUSH MODELO ACTUALIZADO (si se reentrenÃ³)
      # ======================================================================
      
      - name: ðŸ“¤ Push updated model to S3
        if: success()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
        run: |
          if [ -f "models/best_model.pkl" ]; then
            echo "ðŸ“¤ Pusheando modelo actualizado a S3..."
            dvc add models/best_model.pkl || true
            dvc push models/best_model.pkl.dvc || true
            echo "âœ… Modelo versionado en S3"
          else
            echo "âš ï¸ No hay modelo nuevo para pushear"
          fi
      
      # ======================================================================
      # HOT RELOAD API MODEL
      # ======================================================================
      
      - name: ðŸ”„ Hot reload API model
        if: success()
        env:
          API_URL: ${{ secrets.API_URL }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
        run: |
          if [ -z "$API_URL" ] || [ -z "$ADMIN_API_KEY" ]; then
            echo "âš ï¸ API_URL o ADMIN_API_KEY no configuradas, saltando hot reload"
            exit 0
          fi
          
          echo "ðŸ”„ Recargando modelo en API..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$API_URL/admin/reload-model" \
            -H "X-API-Key: $ADMIN_API_KEY" \
            --max-time 30)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Modelo recargado exitosamente"
            echo "$BODY" | python -m json.tool || echo "$BODY"
          else
            echo "âŒ Error recargando modelo (HTTP $HTTP_CODE)"
            echo "$BODY"
            # No fallar el workflow, solo advertir
          fi
      
      # ======================================================================
      # SUMMARY
      # ======================================================================
      
      - name: ðŸ“‹ Generate summary
        if: always()
        run: |
          echo "# ðŸ” Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "models/best_model_metadata.json" ]; then
            python << 'PYTHON_EOF'
          import json
          from pathlib import Path
          from datetime import datetime
          
          try:
              with open('models/best_model_metadata.json', 'r') as f:
                  metadata = json.load(f)
              
              print(f"**Model:** {metadata.get('model_name', 'N/A')}")
              print(f"**F1-Score:** {metadata.get('f1_score', 0):.4f}")
              print(f"**Last Training:** {metadata.get('timestamp', 'N/A')}")
              print(f"**Environment:** {metadata.get('environment', 'N/A')}")
              print("")
              print("### ðŸ“Š Monitoring Status")
              print("")
              print("âœ… Monitoring completed")
              print("")
              print("**Note:** Check logs for drift detection and retraining decisions")
              
          except Exception as e:
              print(f"Error generating summary: {e}")
          PYTHON_EOF
          else
            echo "## âš ï¸ No Model Metadata Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Model may not have been trained yet." >> $GITHUB_STEP_SUMMARY
          fi

